<!DOCTYPE html>
<html> 
<head> 
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" /> 
  <title>SF film locations</title> 
  <link rel="stylesheet" href="//code.jquery.com/ui/1.11.0/themes/smoothness/jquery-ui.css">
  <script src="http://maps.google.com/maps/api/js?sensor=false" 
          type="text/javascript"></script>
  <script src="//code.jquery.com/jquery-1.10.2.js"></script>
  <script src="//code.jquery.com/ui/1.11.0/jquery-ui.js"></script>
  <script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/src/markerclusterer.js"></script>

  <script>
  
  var map;
  var infowindow; 
  var markers=[];
  var markerCluster;

  $(document).ready(function(){
    loadMap();
    loadMovies("");

      $( "#sub" ).click(function() {
       var movieTitle= $( "#tags" ).val();
       loadMovies(movieTitle);


      });

      $( "#clear" ).click(function() {
       $("#tags").val(""); 
       loadMovies("");
      });



    });



  function getMoviesTitles(callback) {
     $.ajax({
        url:'process.php',
        data:{'function':'titles'},
        success: callback,
        error: function () {
            alert('Bummer: there was an error!');
        },
     });
  }


getMoviesTitles(function(result){
  $(function() {
    var availableTags = jQuery.parseJSON(result);

    $( "#tags" ).autocomplete({
      source: availableTags
    });
  });

	
  $("#tags").keyup(function(event){
    if(event.keyCode == 13){
        $("#sub").click();
    }
  });

  $.post('process.php', $('#title-filter').serialize());
});



 function getMovies(callback,title) {

    var title = title;
     $.ajax({
        url:'process.php',
        data:{'function':'movies','mTitle':title},
        success: callback,
        error: function (a,b,c) {
            alert('Bummer: there was an error!');
        },
     });
  }


  function loadMap(){

     map = new google.maps.Map(document.getElementById('map'), {
      zoom: 10,
      center: new google.maps.LatLng(37.775,-122.4183333),
      mapTypeId: google.maps.MapTypeId.ROADMAP
    });

  }
    function loadMovies(title){
      var clustering=true;

      if(title!=""){
         clearOverlays();
         clustering=false;
      }
    
      var infowindow = new google.maps.InfoWindow();

      getMovies(function(result){
        var locations=jQuery.parseJSON(result);
        

        //clear markers

        for (var i = 0; i < locations.length; i++) {  
          var marker = new google.maps.Marker({
            position: new google.maps.LatLng(locations[i].lat, locations[i].long),
            map: map
          });

          markers.push(marker);




          google.maps.event.addListener(marker, 'click', (function(marker, i) {
            return function() {

              var content= '<h3>'+locations[i].title+' ('+locations[i].year+') </h3>  <br> '+ locations[i].director + '<br> '+ locations[i].location;
              infowindow.setContent(content);
              infowindow.open(map, marker);
            }
          })(marker, i));
        }

        if(clustering){
          markerCluster = new MarkerClusterer(map, markers);
        }

     },title);
  }

  function clearOverlays() {

    for (var i = 0; i < markers.length; i++ ) {
      markers[i].setMap(null);
    }
    markers.length = 0;
    markers=[];
    markerCluster.clearMarkers();

   }




  </script>



</head> 
<body>
  
  <form id="title-filter" name="title-filter">

  <div class="ui-widget">
	  <label for="tags">Filter by Movie Title: </label>
	  <input placeholder="Blue Jasmine" type="text" name="title" id="tags"> 
  </div>
  	  <button type="button" id="sub">Submit</button>
  </form>
   
   <button type="button" id="clear">Clear</button>

  <br>
  <br>

  <div id="map" style="width: 1000px; height: 500px;"></div>

  
</body>
</html>